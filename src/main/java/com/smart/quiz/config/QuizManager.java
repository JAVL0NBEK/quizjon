package com.smart.quiz.config;

import com.smart.quiz.QuizService;
import com.smart.quiz.dto.OptionResponseDto;
import com.smart.quiz.dto.QuestionResponseDto;
import com.smart.quiz.dto.QuestionsEntity;
import com.smart.quiz.dto.QuizState;
import com.smart.quiz.dto.SubjectEntity;
import java.util.ArrayList;
import java.util.Collections;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Lazy;
import org.springframework.stereotype.Component;
import org.telegram.telegrambots.meta.api.methods.polls.SendPoll;
import org.telegram.telegrambots.meta.api.methods.send.SendMessage;
import org.telegram.telegrambots.meta.api.objects.replykeyboard.InlineKeyboardMarkup;
import org.telegram.telegrambots.meta.api.objects.replykeyboard.buttons.InlineKeyboardButton;
import org.telegram.telegrambots.meta.exceptions.TelegramApiException;

@Slf4j
@Component
public class QuizManager {

  private final QuizService quizService;
  private final QuizBot quizBot; // QuizBot obyektini qo‚Äòshamiz

  // Har bir foydalanuvchi uchun holatni saqlash uchun Map
  private final Map<Long, QuizState> userStates = new ConcurrentHashMap<>();

  // Bo‚Äòlimlar ro‚Äòyxati (masalan, har birida 30 ta savol)
  private final Map<String, List<Long>> sections = new HashMap<>();

  @Autowired
  public QuizManager(QuizService quizService,@Lazy QuizBot quizBot) {
    this.quizService = quizService;
    this.quizBot = quizBot;
    initializeSections(); // Bo‚Äòlimlarni boshlang‚Äòich holatda yuklash
  }

  // Quizni boshlash: Faol quiz mavjudligini tekshiradi
  public SendMessage startQuiz(Long chatId) {
    QuizState existingState = userStates.get(chatId);

    // Agar foydalanuvchi allaqachon quizda bo‚Äòlsa
    if (existingState != null && existingState.isActive()) {
      return createMessage(chatId, "‚ùå Siz allaqachon quizdasiz! Avval uni tugating yoki /stop buyrug‚Äòidan foydalaning.");
    }

    // Yangi holat yaratib, fanlarni ko‚Äòrsatamiz
    userStates.put(chatId, new QuizState());
    return showSubjects(chatId);
  }

  // Fanlar ro‚Äòyxatini ko‚Äòrsatish
  private SendMessage showSubjects(Long chatId) {
    SendMessage message = new SendMessage();
    message.setChatId(chatId.toString());
    message.setText("üìö Fanlardan birini tanlang:");

    List<SubjectEntity> subjects = quizService.getAllSubjects();
    List<List<InlineKeyboardButton>> keyboard = new ArrayList<>();

    for (SubjectEntity subject : subjects) {
      InlineKeyboardButton selectButton = new InlineKeyboardButton();
      selectButton.setText(subject.getSubjectName());
      selectButton.setCallbackData("subject_" + subject.getId());

      InlineKeyboardButton shareButton = new InlineKeyboardButton();
      shareButton.setText("üì§ Ulashish");
      shareButton.setCallbackData("share_subject_" + subject.getId());

      keyboard.add(List.of(selectButton, shareButton));
    }

    InlineKeyboardMarkup markup = new InlineKeyboardMarkup();
    markup.setKeyboard(keyboard);
    message.setReplyMarkup(markup);

    return message;
  }

  private void initializeSections() {
    List<Long> allQuestionIds = quizService.getAllQuestionIds();
    int sectionSize = 30;
    int sectionCount = (int) Math.ceil((double) allQuestionIds.size() / sectionSize);

    for (int i = 0; i < sectionCount; i++) {
      int start = i * sectionSize;
      int end = Math.min(start + sectionSize, allQuestionIds.size());
      sections.put("Bo‚Äòlim " + (i + 1), allQuestionIds.subList(start, end));
    }
  }

  // Callback query ni qayta ishlash
  public void processCallbackQuery(Long userId, String callbackData) throws TelegramApiException {
    QuizState state = userStates.get(userId);

    if (state != null && state.isActive() && state.getCurrentSection() != null) {
      quizBot.execute(createMessage(userId, "‚ùå Siz allaqachon quizdasiz! Avval tugating yoki /stop buyrug‚Äòidan foydalaning."));
      return;
    }

    // Fanni tanlash
    if (callbackData.startsWith("subject_")) {
      Long subjectId = Long.parseLong(callbackData.replace("subject_", ""));
      startSubjectQuiz(userId, subjectId);
    }
    // Fanni ulashish
    else if (callbackData.startsWith("share_subject_")) {
      Long subjectId = Long.parseLong(callbackData.replace("share_subject_", ""));
      quizBot.execute(shareSubject(userId, subjectId));
    }
    // Bo‚Äòlimni tanlash
    else if (callbackData.startsWith("section_")) {
      String selectedSection = callbackData.replace("section_", "");
      if (state.getSections().containsKey(selectedSection)) {
        state.setCurrentSection(selectedSection);
        state.setCurrentQuestionIndex(0);
        state.setCorrectAnswersCount(0);
        state.setWrongAnswersCount(0);
        state.setActive(true);
        quizBot.execute(getQuestionMessage(userId));
      } else {
        quizBot.execute(createMessage(userId, "‚ùå Bunday bo‚Äòlim mavjud emas!"));
      }
    }

  }

  private void startSubjectQuiz(Long userId, Long subjectId) throws TelegramApiException {
    QuizState state = userStates.get(userId);
    List<QuestionsEntity> questions = quizService.getQuestionsBySubjectId(subjectId);

    if (questions.isEmpty()) {
      quizBot.execute(createMessage(userId, "‚ùå Ushbu fanda savollar mavjud emas!"));
      return;
    }

    Map<String, List<Long>> sections = createSections(questions);
    state.setSections(sections);
    state.setSubjectId(subjectId);
    quizBot.execute(showSections(userId));
  }

  private SendMessage shareSubject(Long userId, Long subjectId) {
    String botUsername = quizBot.getBotUsername();
    String shareLink = String.format("https://t.me/%s?start=subject_%d", botUsername, subjectId);

    SubjectEntity subject = quizService.getSubjectById(subjectId); // Fan nomini olish uchun
    String shareMessage = String.format("""
            üì¢ Do‚Äòstlaringizni %s fanidan quizga taklif qiling!
            Quyidagi havolani ularga yuboring:
            %s
            
            Ular ham ushbu testni sinab ko‚Äòrishlari mumkin!
            """, subject.getSubjectName(), shareLink);

    return createMessage(userId, shareMessage);
  }

  // Savollarni bo‚Äòlimlarga bo‚Äòlish
  private Map<String, List<Long>> createSections(List<QuestionsEntity> questions) {
    Map<String, List<Long>> sections = new HashMap<>();
    int sectionSize = 30; // Har bir bo‚Äòlimda 30 ta savol
    int sectionCount = (int) Math.ceil((double) questions.size() / sectionSize);

    for (int i = 0; i < sectionCount; i++) {
      int start = i * sectionSize;
      int end = Math.min(start + sectionSize, questions.size());
      List<Long> questionIds = questions.subList(start, end).stream()
          .map(QuestionsEntity::getId)
          .toList();
      sections.put("Bo‚Äòlim " + (i + 1), questionIds);
    }
    return sections;
  }

  // Tanlangan fan bo‚Äòyicha bo‚Äòlimlarni ko‚Äòrsatish
  private SendMessage showSections(Long userId) {
    QuizState state = userStates.get(userId);
    SendMessage message = new SendMessage();
    message.setChatId(userId.toString());
    message.setText("üìö Bo‚Äòlimni tanlang:");

    List<List<InlineKeyboardButton>> keyboard = new ArrayList<>();
    List<String> sortedSections = new ArrayList<>(state.getSections().keySet());
    Collections.sort(sortedSections);

    for (String section : sortedSections) {
      InlineKeyboardButton button = new InlineKeyboardButton();
      button.setText(section);
      button.setCallbackData("section_" + section);
      keyboard.add(List.of(button));
    }

    InlineKeyboardMarkup markup = new InlineKeyboardMarkup();
    markup.setKeyboard(keyboard);
    message.setReplyMarkup(markup);

    return message;
  }

  public SendMessage exitBot(Long userId) {
    QuizState state = userStates.remove(userId); // Holatni tozalash
    if (state != null && state.isActive()) {
      return createMessage(userId, "üëã Quiz to‚Äòxtatildi. Qaytadan boshlash uchun /quiz buyrug‚Äòidan foydalaning.");
    }
    return createMessage(userId, "üëã Botdan chiqdingiz. Qaytadan boshlash uchun /start ni yuboring.");
  }

  public SendPoll getQuestionMessage(Long userId) {
    QuizState state = userStates.get(userId);
    List<Long> sectionQuestions = state.getSections().get(state.getCurrentSection());
    Long currentQuestionId = sectionQuestions.get(state.getCurrentQuestionIndex());

    QuestionResponseDto question = quizService.getQuestionById(currentQuestionId);

    SendPoll poll = new SendPoll();
    poll.setChatId(userId.toString());
    poll.setQuestion((state.getCurrentQuestionIndex() + 1) + ". " + question.getQuestionText());
    poll.setOptions(question.getOptions().stream()
        .map(option -> trimOptionText(option.getOptionText()))
        .toList());
    poll.setType("quiz");
    poll.setCorrectOptionId(findCorrectOptionIndex(question));
    poll.setIsAnonymous(false);

    return poll;
  }

  public void processPollAnswer(Long userId, Integer selectedOption) {
    QuizState state = userStates.get(userId);
    List<Long> sectionQuestions = state.getSections().get(state.getCurrentSection());
    Long currentQuestionId = sectionQuestions.get(state.getCurrentQuestionIndex());

    QuestionResponseDto question = quizService.getQuestionById(currentQuestionId);
    boolean isCorrect = selectedOption.equals(findCorrectOptionIndex(question));

    if (isCorrect) {
      state.incrementCorrectAnswers();
    } else {
      state.incrementWrongAnswers();
    }

    state.incrementQuestionIndex();

    try {
      if (state.getCurrentQuestionIndex() < sectionQuestions.size()) {
        quizBot.execute(getQuestionMessage(userId));
      } else {
        quizBot.execute(sendStatistics(userId));
        state.setActive(false); // Quiz tugadi
        userStates.remove(userId); // Holatni o‚Äòchirish
      }
    } catch (TelegramApiException e) {
      log.error("Xatolik yuz berdi: {}", e.getMessage());
    }
  }

  private int findCorrectOptionIndex(QuestionResponseDto question) {
    List<OptionResponseDto> options = question.getOptions();
    for (int i = 0; i < options.size(); i++) {
      if (options.get(i).isCorrect()) {
        return i;
      }
    }
    return -1;
  }

  private String trimOptionText(String option) {
    return option.length() > 100 ? option.substring(0, 97) + "..." : option;
  }

  public SendMessage createMessage(Long chatId, String text) {
    SendMessage message = new SendMessage();
    message.setChatId(chatId.toString());
    message.setText(text);
    return message;
  }

  // Statistika yuborish
  public SendMessage sendStatistics(Long userId) {
    QuizState state = userStates.get(userId);
    SendMessage message = new SendMessage();
    message.setChatId(userId.toString());

    if (state == null || !state.isActive()) {
      message.setText("‚ùå Hozirda faol quiz mavjud emas! Quizni boshlash uchun /quiz buyrug‚Äòidan foydalaning.");
    } else {
      long totalQuestions = state.getCorrectAnswersCount() + state.getWrongAnswersCount();
      double correctPercentage = totalQuestions > 0 ? (double) state.getCorrectAnswersCount() / totalQuestions * 100 : 0.0;

      String statsMessage = String.format(
          "üìä *Statistika (%s):*\n\n" +
          "‚Ä¢ üìå Umumiy savollar: %d\n" +
          "‚Ä¢ ‚úÖ To'g'ri javoblar: %d (%.2f%%)\n" +
          "‚Ä¢ ‚ùå Noto'g'ri javoblar: %d",
          state.getCurrentSection(),
          totalQuestions,
          state.getCorrectAnswersCount(),
          correctPercentage,
          state.getWrongAnswersCount()
      );
      message.setText(statsMessage);
      state.setActive(false); // Statistika ko‚Äòrsatilgandan keyin quiz faol emas
    }

    message.setParseMode("Markdown");
    return message;
  }

  public SendMessage sendQuestionFormatInfo(Long chatId) {
    String infoMessage = """
        üìå *Savollarni to‚Äòg‚Äòri formatda yozish bo‚Äòyicha qo‚Äòllanma:*

        ‚úÖ *Savollar* quyidagi belgilardan biri bilan tugashi kerak:
        - `?` (Savol belgisidan foydalanish shart)
        - `:` (Ikki nuqta)
        - `...` (Uch nuqta)
        - `!` (Undov belgisi)
        - `__` (Pasti chiziqchalar savol matni orasida qatnashishi mumkin)

        ‚ùå *Noto‚Äòg‚Äòri yozilgan savollar* variant sifatida qabul qilinishi mumkin.

        üìù *Misol:*
        ‚ùå Noto‚Äòg‚Äòri: `Dunyodagi eng kichik qush`
        ‚úÖ To‚Äòg‚Äòri: `Dunyodagi eng kichik qush?`
        ‚úÖ To‚Äòg‚Äòri: `Dunyodagi eng kichik qush:`
        ‚úÖ To‚Äòg‚Äòri: `Dunyodagi eng kichik qush...`
        ‚úÖ To‚Äòg‚Äòri: `Dunyodagi eng kichik qush!`
        ‚úÖ To‚Äòg‚Äòri: `Dunyodagi eng ____ qush`
        
        *üì¢ Iltimos, savollaringizni to‚Äòg‚Äòri shaklda yozing!*
        """;

    SendMessage message = new SendMessage();
    message.setChatId(chatId);
    message.setText(infoMessage);
    message.setParseMode("Markdown");

    return message;
  }

  // Botni ulashish uchun havola yaratish
  public SendMessage shareBot(Long chatId) {
    String botUsername = quizBot.getBotUsername(); // Bot nomini dinamik olish
    String shareLink = String.format("https://t.me/%s?start=%d", botUsername, chatId);

    String shareMessage = """
        üì¢ Do‚Äòstlaringizni quizga taklif qiling!
        Quyidagi havolani ularga yuboring:
        %s
        
        Ular ham sizning testingizni sinab ko‚Äòrishlari mumkin!
        """.formatted(shareLink);

    return createMessage(chatId, shareMessage);
  }

  // Deep link orqali kelgan taklifni qayta ishlash
  public SendMessage handleInvite(Long chatId, String param) {
    if (param.startsWith("subject_")) {
      try {
        Long subjectId = Long.parseLong(param.replace("subject_", ""));
        SubjectEntity subject = quizService.getSubjectById(subjectId);
        if (subject == null) {
          return createMessage(chatId, "‚ùå Bunday fan mavjud emas!");
        }

        userStates.put(chatId, new QuizState());
        startSubjectQuiz(chatId, subjectId);
        return createMessage(chatId, String.format("üëã %s fanidan quizga xush kelibsiz! Bo‚Äòlimni tanlang.", subject.getSubjectName()));
      } catch (NumberFormatException | TelegramApiException e) {
        return createMessage(chatId, "‚ùå Taklif havolasi noto‚Äòg‚Äòri!");
      }
    }
    return createMessage(chatId, "‚ùå Noto‚Äòg‚Äòri taklif havolasi!");
  }

}
